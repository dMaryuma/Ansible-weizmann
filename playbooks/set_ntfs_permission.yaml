---
# Ensure that the NetApp Ansible collection is deployed by running ansible-galaxy collection install netapp.ontap
- hosts: localhost
  collections:
    - netapp.ontap
  gather_facts: no
  vars:
    login: &login
      username: "{{ username }}"
      password: "{{ password }}"
      hostname: "{{ cluster_hostname }}"
      https: true
      validate_certs: false
  tasks:
  - name: Create File Directory Security Descriptor
    netapp.ontap.na_ontap_fdsd:
      state: present
      name: "{{ ntfs_sd }}"
      vserver: "{{ vserver }}"
      <<: *login

  - name: Add NTFS DACL entries to Security Descriptor
    netapp.ontap.na_ontap_ntfs_dacl:
      state: present
      vserver: "{{ vserver }}"
      security_descriptor: "{{ ntfs_sd }}"
      access_type: "{{ item.access_type }}"
      account: "{{ item.user }}"
      rights: "{{ item.rights }}"
      apply_to: "{{ item.apply_to }}"
      <<: *login
      use_rest: always
    loop: "{{ ntfs_permission }}"

  - name: Create File Directory Security Policy Task
    netapp.ontap.na_ontap_fdspt:
      state: present
      name: "{{ policy_name }}"
      vserver: "{{ vserver }}"
      access_control: "file_directory"
      ntfs_sd: "{{ ntfs_sd }}"
      ntfs_mode: "{{ ntfs_mode }}"
      path: "{{ path }}"
      <<: *login

  - name: Apply File Directory Task
    netapp.ontap.na_ontap_fdss:
      state: present
      vserver: "{{ vserver }}"
      name: "{{ policy_name }}"
      <<: *login

  - name: Wait for task to complete...
    pause:
      seconds: 5

### last task delete the policy and task
  - name: Delete File Directory Policy along with the tasks
    netapp.ontap.na_ontap_file_directory_policy:
      state: absent
      vserver: "{{ vserver }}"
      policy_name: "{{ policy_name }}"
      <<: *login

  - name: Delete File Directory Security Descriptor
    netapp.ontap.na_ontap_fdsd:
      state: absent
      name: "{{ ntfs_sd }}"
      vserver: "{{ vserver }}"
      <<: *login
